# GeoNexus 数据中台 - 整体架构设计

## 引言：地理空间数据中枢的愿景

GeoNexus 数据中台是一个革命性的地理空间数据集成平台，旨在成为企业级地理信息系统的核心枢纽。作为一个"地理空间中枢"，GeoNexus 连接多源异构数据，提供统一的访问接口，并通过先进的数据处理能力，为各类空间应用提供强大支持。

## 问题陈述

在开发数字孪生项目的过程中，我们反复遭遇了一系列根深蒂固的技术挑战，这些挑战不仅影响了开发效率，更制约了最终产品的用户体验：

1. **静态与动态数据的矛盾**：三维场景底座（如地形、建筑模型）需要高性能渲染，而业务数据（如物联网传感器、实时监控）则要求最大化实时性。传统架构中，这两类数据被迫共存于同一系统，导致性能与实时性的尖锐矛盾。

2. **数据格式与坐标系的碎片化**：不同来源的数据采用不同的格式和坐标系，前端应用需要编写大量的转换逻辑，增加了开发复杂度和维护成本。

3. **API接口的不一致性**：前端应用需要对接多种后端API（空间数据库、业务系统、媒体服务器等），每种API都有不同的认证方式、请求格式和错误处理机制，导致前端代码臃肿且难以维护。

4. **缺乏统一的安全策略**：各个数据源采用不同的安全机制，难以实现统一的访问控制和审计，增加了安全风险和合规难度。

5. **媒体资产与空间数据的割裂**：传统GIS系统对非空间数据（如视频、图像）的支持有限，导致媒体资产与空间要素的关联管理复杂且低效。

## 核心设计哲学：静动分离

面对上述挑战，我们提出了"静动分离"的核心设计哲学——**承认并拥抱数据的二元性**。

### 为什么选择"静动分离"？

"静动分离"不是简单的技术选择，而是对数字孪生数据本质的深刻洞察：

1. **数据生命周期的差异**：静态场景数据（如建筑模型）更新频率低，可以预先优化；动态业务数据（如传感器读数）变化迅速，需要实时响应。

2. **处理逻辑的差异**：静态数据适合预处理和缓存优化；动态数据则需要即时查询和转换。

3. **存储需求的差异**：静态数据（特别是3D模型）体积大，适合对象存储；动态数据则更适合关系型或时序数据库。

通过分离这两类本质不同的数据，我们能够为每类数据匹配最合适的处理引擎，从而实现"性能"与"实时性"的兼得，这是传统一体化架构难以实现的。

## 整体架构

![GeoNexus数据中台架构图](https://via.placeholder.com/800x500?text=GeoNexus数据中台架构图)

GeoNexus数据中台采用"API网关 + 微服务"的现代架构模式，主要由以下核心组件构成：

### 1. API网关层

**为什么选择API网关？**

API网关不仅仅是一个反向代理，它是整个架构的"前门"，承担着多重关键职责：

- **统一入口**：为所有客户端提供单一访问点，简化前端开发，增强系统弹性。
- **路由与负载均衡**：智能分发请求到适当的微服务，实现负载均衡和故障隔离。
- **认证与授权**：集中处理身份验证和权限控制，确保安全一致性。
- **请求转换**：标准化不同客户端的请求格式，减轻后端服务的负担。
- **监控与限流**：提供系统级的监控和流量控制，防止过载和滥用。

在生产环境中，API网关前通常还会部署负载均衡器，进一步提高系统的可用性和性能。

### 2. 双核微服务层

#### 2.1 GeoNexus 要素引擎

**为什么选择Koop作为要素引擎的基础？**

Koop是一个强大的"即时转换"引擎，而非传统的ETL工具。这种架构选择带来了几个关键优势：

- **实时性**：数据不需要预先转换和存储，而是在请求时即时处理，确保了最高的数据新鲜度。
- **格式统一**：将各种数据源转换为标准的GeoJSON或Esri Feature Service格式，消除了前端处理多种格式的复杂性。
- **可扩展性**：通过Provider插件机制，可以轻松集成新的数据源，而无需修改核心代码。
- **标准兼容**：支持OGC和Esri等行业标准，确保与现有GIS工具和库的兼容性。

我们的企业级PostGIS Provider在官方Provider的基础上增加了安全白名单、审计日志和增强元数据等企业级特性，进一步提升了系统的安全性和可管理性。

#### 2.2 GeoNexus 资产服务

**为什么选择独立的资产服务？**

将媒体资产管理分离为独立服务，而不是让要素引擎承担所有职责，这一决策基于以下考量：

- **专业化分工**：资产服务专注于媒体资产的管理、处理和分发，要素引擎专注于空间数据处理，各自发挥所长。
- **性能优化**：媒体资产（如高清视频）和空间数据有不同的存储和传输需求，分离后可以针对性优化。
- **灵活扩展**：两个服务可以独立扩展，根据实际负载调整资源分配。
- **技术适配**：选择Directus作为资产服务的实现，是因为其"无头"和"API优先"的特性与我们的微服务架构完美契合。

### 3. 数据存储层

- **空间数据库**：采用PostGIS，为空间数据提供高效的存储和查询能力。
- **资产数据库**：存储媒体资产的元数据和关联信息。
- **对象存储**：用于存储大型媒体文件，如视频、高分辨率图像等。

## 数据工作流详解

让我们通过一个完整的用户故事，来展示各组件如何协同工作：

### 用户故事：智慧城市管理员查看异常灯杆及其监控画面

1. **用户交互**：
   城市管理员在三维数字孪生平台上，需要查看所有状态为"警告"的智慧灯杆，并查看其最新的监控画面，以便评估情况并做出响应。

2. **请求流程**：
   - 用户在三维客户端点击"显示异常灯杆"按钮
   - 客户端向API网关发送请求：`GET /koop/provider-postgis-enterprise/public.smart_poles/FeatureServer/0/query?where=status='warning'&f=geojson`
   - API网关验证用户身份和权限
   - 请求被路由到Koop要素服务

3. **要素引擎处理**：
   - GeoNexus 要素引擎的 PostGIS Provider 接收请求
   - 检查表名`public.smart_poles`是否在安全白名单中
   - 记录审计日志，包含用户ID、IP、查询参数等
   - 连接到PostGIS数据库，执行空间查询
   - 将查询结果转换为GeoJSON格式
   - 添加增强元数据（提供者信息、时间戳、查询时间等）
   - 返回结果给API网关

4. **媒体资产获取**：
   - 用户在三维场景中点击某个异常灯杆
   - 客户端从灯杆属性中获取关联的媒体资产ID：`video-2025-08-24-0042`
   - 客户端向API网关发送请求：`GET /dam/assets/video-2025-08-24-0042`
   - API网关将请求路由到资产服务
   - 资产服务验证访问权限，从对象存储中获取视频文件
   - 返回视频流或下载链接给客户端

5. **结果呈现**：
   - 三维场景中显示所有异常灯杆，用醒目的红色标记
   - 用户点击特定灯杆，侧边栏显示详细信息和关联的监控视频
   - 用户可以播放视频，查看异常情况，并做出响应决策

这个工作流程展示了"静动分离"架构的优势：静态的城市模型作为底座，动态的灯杆状态数据和视频资产通过要素引擎和资产服务实时叠加，为用户提供完整、实时的决策支持信息。

## 安全架构

安全性是企业级系统的核心要求，我们的框架实现了多层次的安全防护：

1. **网关层安全**：
   - JWT认证
   - 请求限流
   - IP白名单
   - HTTPS加密

2. **服务层安全**：
   - 表级白名单（企业级PostGIS Provider）
   - 全面审计日志
   - 参数化查询防注入

3. **数据层安全**：
   - 最小权限原则
   - 数据库加密
   - 定期备份

## 部署架构

### 开发环境

开发环境采用Docker Compose进行容器化部署，包含所有必要的服务和数据库，便于快速启动和测试。

### 生产环境

生产环境推荐采用Kubernetes进行容器编排，实现高可用、自动扩展和滚动更新。在API网关前部署负载均衡器，进一步提高系统的可用性和性能。

## 结论

GeoNexus数据中台通过"静动分离"的创新设计理念和"API网关 + 双核微服务"的现代架构，成功解决了数字孪生领域中静态场景与动态业务数据融合的核心挑战。这一架构不仅提高了系统的性能和实时性，还增强了安全性、可维护性和可扩展性，为三维数字孪生应用提供了坚实的数据基础。
