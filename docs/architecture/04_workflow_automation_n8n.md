# GeoNexus 架构：n8n 工作流自动化引擎

## 1. 什么是 n8n？

n8n（发音为"n-eight-n"）是一个强大的开源工作流自动化工具，它提供了直观的可视化界面，让用户能够通过简单的拖拽操作来设计和执行复杂的自动化流程。作为一个可自托管的解决方案，n8n 可以被视为开源版的 Zapier 或企业级的 IFTTT，但它提供了更高的灵活性和可定制性。

n8n 的核心优势在于它能够连接各种不同的系统和服务，通过预定义的节点（Nodes）来执行特定的操作，并将这些节点组合成完整的工作流（Workflow）。无论是 API 调用、数据库操作、文件处理，还是与第三方服务的集成，n8n 都能够以一种无缝的方式将它们串联起来，实现端到端的自动化。

## 2. 为什么在 GeoNexus 中集成 n8n？(战略价值)

### 超越"数据提供"

GeoNexus 数据中台的初衷是作为一个集中化的数据管理和提供平台，为各类应用提供地理空间数据服务。然而，通过集成 n8n，我们将 GeoNexus 从一个被动的"数据中台"提升为了一个主动的**"业务流程自动化中心"**。

这种转变意味着 GeoNexus 不再仅仅是数据的提供者，而是能够基于数据**触发行动**的智能平台。当特定的数据条件满足时，系统可以自动执行预设的操作，如发送通知、更新记录、调用外部服务等，从而将数据洞察转化为实际的业务价值。

### "事件驱动"架构

n8n 是我们实现"事件驱动"架构的关键组件。在传统的请求-响应模式中，系统只有在收到明确请求时才会做出反应。而在事件驱动架构中，系统能够主动监听和响应各种事件，无需人工干预。

通过 n8n，GeoNexus 可以监听来自多种来源的事件：
- **内部事件**：如数据库记录的变更、API 调用的触发、文件的上传或修改
- **外部事件**：如来自钉钉、企业微信的消息、邮件的接收、第三方系统的通知

一旦检测到这些事件，n8n 就可以自动执行一系列预设的流程，实现系统间的协同工作和信息的实时流转，大大提高了整个平台的响应速度和处理效率。

### 低代码/无代码赋能

n8n 的可视化编排能力是其最显著的特点之一。通过直观的拖拽界面和预配置的节点，即使是非专业开发者（如业务分析师、运维人员、产品经理）也能够创建功能强大的自动化工作流。

这种低代码/无代码的方式极大地降低了技术门槛，使得更多的团队成员能够参与到自动化流程的设计和实现中来。业务部门不再需要完全依赖 IT 团队来实现他们的自动化需求，而是可以自主地构建和调整工作流，从而：

- 加速业务创新和迭代
- 减轻开发团队的负担
- 提高组织的整体敏捷性
- 缩短从需求到实现的周期

通过这种方式，GeoNexus 不仅提供了数据和服务，还提供了一个平台，让各个部门能够根据自己的需求，灵活地构建自动化解决方案。

## 3. n8n 在 GeoNexus 中的典型应用场景 (落地案例)

### 场景一：安全审计与实时告警

**触发**：n8n 定时轮询 GeoNexus 的审计日志数据库 (data_access_logs表)。

**流程**：当发现有高风险操作（如访问未授权的表、短时间内大量查询、敏感数据访问）时，n8n 会提取相关的日志信息，包括操作时间、用户ID、访问的资源、操作类型等。然后，它会对这些信息进行分析和格式化，生成一条结构化的告警消息。

**行动**：n8n 通过企业微信或钉钉的 Webhook，向安全管理员的专用频道发送一条**格式化的告警消息**。这条消息不仅包含基本的告警信息，还可能包含直接链接到管理界面的URL，方便管理员快速查看详情和采取行动。同时，系统还会将这些告警记录到专门的安全事件数据库中，以便后续的分析和审计。

这个场景使安全团队能够实时了解系统中的潜在安全风险，而不必手动监控日志或等待定期的安全审计报告。

### 场景二：媒体资产的 AI 自动化处理

**触发**：n8n 监听 RustFS 的文件上传事件（通过 Webhook）。

**流程**：当有新的巡检视频上传到"待处理"存储桶时，n8n 自动获取该视频的元数据（如文件名、大小、上传时间、上传者等）。然后，它将视频文件及其元数据提交给一个外部的 AI 视频分析服务（如华为云 ModelArts）。AI 服务会对视频进行分析，识别出视频中的物体、事件、异常情况等。

**行动**：AI 分析完成后，n8n 接收分析结果，并将这些结构化的标签信息（如识别出的设备类型、故障类型、严重程度等）通过调用 DAM (Directus) 的 API，**自动更新**到该视频资产的元数据中。此外，如果发现高优先级的问题（如设备故障），n8n 还可以自动创建工单并通知相关人员。最后，处理完成的视频会被移动到"已处理"存储桶，并在资产管理系统中标记为已分析状态。

这个场景大大减少了手动处理媒体资产的工作量，同时提高了数据的丰富度和可用性，使得后续的检索和分析更加高效。

### 场景三：与外部业务系统的数据同步

**触发**：GeoNexus 的前端应用中，用户在三维场景里创建了一个新的"故障工单"要素，并通过 Koop API 写入了spatial_db。

**流程**：n8n 监听到business_features表的新增操作（通过数据库触发器或轮询）。它提取新工单的详细信息，包括位置坐标、故障类型、描述、优先级等。然后，n8n 将这些信息转换为目标系统所需的格式，并准备API调用所需的参数。

**行动**：n8n 调用公司内部 **CRM 或工单系统**的 API，将这个新工单同步过去，实现数字孪生平台与核心业务系统的**双向联动**。当工单状态在CRM系统中更新时（如已分配、处理中、已解决），n8n 也可以通过反向监听这些变化，并将最新状态同步回 GeoNexus，确保两个系统中的数据始终保持一致。此外，n8n 还可以根据工单的优先级和类型，自动通知相关的现场人员或管理者。

这个场景打破了系统间的信息孤岛，确保了业务数据在不同平台间的无缝流转，提高了整体的工作效率和协同能力。

## 4. 快速开始：创建一个你的第一个工作流

下面是一个简单的教程，帮助你创建第一个 n8n 工作流，用于监控 GeoNexus 平台的健康状态：

### 1. 访问 n8n

打开浏览器，访问 `http://localhost:5678`（默认端口）或 `http://localhost/n8n/`（如果已在 Nginx 中配置了 /n8n 路由）。

使用系统管理员提供的凭据登录 n8n 界面。

### 2. 创建新工作流

在 n8n 的主界面上，点击右上角的 "Add workflow" 按钮。

为你的工作流命名，例如 "GeoNexus 健康监控"。

### 3. 配置触发器

在工作流编辑器中，点击左侧的 "+" 按钮，搜索并选择 "Cron" 节点。

配置 Cron 节点，设置为每分钟触发一次（你可以根据需要调整频率）：
- 模式选择 "Every Minute"
- 点击 "Save" 保存配置

### 4. 添加 HTTP 请求节点

再次点击 "+" 按钮，搜索并选择 "HTTP Request" 节点。

将其连接到 Cron 节点（拖拽连线）。

配置 HTTP Request 节点：
- 请求方法：GET
- URL：`http://gateway/health` 或 `http://localhost:8080/health`（根据你的环境配置）
- 点击 "Execute Node" 测试请求是否成功
- 点击 "Save" 保存配置

### 5. 添加逻辑节点

点击 "+" 按钮，搜索并选择 "IF" 节点。

将其连接到 HTTP Request 节点。

配置 IF 节点：
- 条件 1：`{{$node["HTTP Request"].json["statusCode"]}} == 200`
- 点击 "Save" 保存配置

### 6. 配置行动节点

#### 对于成功路径：

点击 "+" 按钮，搜索并选择 "NoOp" 节点。

将其连接到 IF 节点的 "true" 输出。

#### 对于失败路径：

点击 "+" 按钮，搜索并选择 "Send Email" 或 "Discord" 或 "Slack" 节点（根据你的通知偏好）。

这里我们以 "Send Email" 为例：
- 配置收件人、主题（如 "GeoNexus 健康检查失败"）
- 邮件内容：`GeoNexus 健康检查失败，状态码：{{$node["HTTP Request"].json["statusCode"]}}`
- 点击 "Save" 保存配置

### 7. 激活并测试

点击右上角的 "Active" 开关，激活工作流。

等待几分钟，观察工作流的执行情况。你可以在 n8n 界面的 "Executions" 标签页中查看历史执行记录。

如果一切正常，你的工作流将每分钟检查一次 GeoNexus 的健康状态，并在发现问题时自动发送通知。

### 8. 进一步探索

一旦你掌握了基本的工作流创建方法，你可以尝试更复杂的场景：
- 连接数据库节点，监控特定表的变化
- 使用 HTTP Webhook 节点，接收外部系统的事件通知
- 结合多个条件和操作，构建更复杂的业务逻辑

n8n 提供了丰富的节点类型和配置选项，可以满足各种自动化需求。通过不断的实践和探索，你将能够充分发挥 n8n 在 GeoNexus 平台中的潜力。