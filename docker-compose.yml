services:
  # 1. API 网关 (Nginx)
  gateway:
    image: nginx:1.21-alpine
    container_name: geonexus_gateway
    ports:
      - "8080:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./test-client:/usr/share/nginx/html/test-client
    networks:
      - geonexus-net
    depends_on:
      - feature_engine
      - asset_service

  # 2. GeoNexus 要素引擎
  feature_engine:
    container_name: geonexus_feature_engine
    image: node:14  # 使用官方Node.js镜像
    working_dir: /usr/src/app
    command: >
      sh -c "
      mkdir -p /usr/src/app/node_modules &&
      cd /usr/src/app &&
      npm install --no-save express &&
      PORT=7071 node express-server.js
      "
    environment:
      - POSTGRES_HOST=spatial_db
      - POSTGRES_USER=${SPATIAL_DB_USER}
      - POSTGRES_PASSWORD=${SPATIAL_DB_PASSWORD}
      - POSTGRES_DB=${SPATIAL_DB_NAME}
      - NODE_ENV=development
      - NPM_CONFIG_REGISTRY=https://registry.npmmirror.com
    volumes:
      - ./apps/feature-engine:/usr/src/app
      - ./packages:/usr/src/packages
    ports:
      - "7071:7071"  # 直接暴露要素引擎服务端口，便于调试
    networks:
      - geonexus-net
    depends_on:
      - spatial_db

  # 3. GeoNexus 资产服务 (Directus)
  asset_service:
    image: directus/directus:9.0.0-rc.90
    platform: linux/amd64
    container_name: geonexus_asset_service
    ports:
      - "6062:8055" # 临时暴露Directus端口便于直接调试
    environment:
      - KEY=${DIRECTUS_SECRET_KEY}
      - SECRET=${DIRECTUS_SECRET_KEY} # Older versions might use SECRET
      - DB_CLIENT=pg
      - DB_HOST=asset_db
      - DB_PORT=5432
      - DB_DATABASE=${ASSET_DB_NAME}
      - DB_USER=${ASSET_DB_USER}
      - DB_PASSWORD=${ASSET_DB_PASSWORD}
      - ADMIN_EMAIL=${DIRECTUS_ADMIN_EMAIL}
      - ADMIN_PASSWORD=${DIRECTUS_ADMIN_PASSWORD}
      - STORAGE_LOCATIONS=rustfs
      - STORAGE_RUSTFS_DRIVER=s3
      - STORAGE_RUSTFS_ENDPOINT=http://object_storage:9000
      - STORAGE_RUSTFS_BUCKET=geonexus-assets
      - STORAGE_RUSTFS_KEY=${RUSTFS_ACCESS_KEY:-rustfs}
      - STORAGE_RUSTFS_SECRET=${RUSTFS_SECRET_KEY:-rustfs_secret}
      - STORAGE_RUSTFS_REGION=${RUSTFS_REGION:-cn-north-1}
      - STORAGE_RUSTFS_S3_FORCE_PATH_STYLE=true
    networks:
      - geonexus-net
    depends_on:
      - asset_db
      - object_storage

  # 4. 空间数据库 (PostGIS for 要素引擎)
  spatial_db:
    image: postgis/postgis:12-3.0
    platform: linux/amd64
    container_name: geonexus_spatial_db
    environment:
      - POSTGRES_USER=${SPATIAL_DB_USER}
      - POSTGRES_PASSWORD=${SPATIAL_DB_PASSWORD}
      - POSTGRES_DB=${SPATIAL_DB_NAME}
    volumes:
      - spatial_db_data:/var/lib/postgresql/data
      - ./db/spatial-db/init:/docker-entrypoint-initdb.d
    networks:
      - geonexus-net

  # 5. 资产数据库 (PostgreSQL for 资产服务)
  asset_db:
    image: postgres:12-alpine
    platform: linux/amd64
    container_name: geonexus_asset_db
    environment:
      - POSTGRES_USER=${ASSET_DB_USER}
      - POSTGRES_PASSWORD=${ASSET_DB_PASSWORD}
      - POSTGRES_DB=${ASSET_DB_NAME}
    volumes:
      - asset_db_data:/var/lib/postgresql/data
      - ./db/asset-db/init:/docker-entrypoint-initdb.d
    networks:
      - geonexus-net

  # 6. 对象存储 (RustFS for 资产服务)
  object_storage:
    image: rustfs/rustfs:latest
    platform: linux/amd64
    container_name: geonexus_object_storage
    ports:
      - "9090:9000" # S3 API Port
    environment:
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY:-rustfs}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY:-rustfs_secret}
    volumes:
      - ./storage:/data
    networks:
      - geonexus-net

  # 7. 管理界面 (DPanel - Docker管理面板)
  admin_ui:
    image: dpanel/dpanel:latest
    container_name: geonexus_admin_ui
    restart: always
    ports:
      - "9092:8080"
    environment:
      - DPANEL_ADMIN_USER=admin
      - DPANEL_ADMIN_PASSWORD=${DPANEL_PASSWORD:-adminpassword}
      - DPANEL_ENABLE_TELEMETRY=false
      - DPANEL_LOG_LEVEL=info
      - APP_NAME=geonexus_admin_ui
    volumes:
      - dpanel_data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - geonexus-net

  # 8. n8n 工作流自动化平台
  n8n:
    image: n8nio/n8n:latest
    container_name: geonexus_n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-admin}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://${N8N_HOST:-localhost}:5678/
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - geonexus-net

volumes:
  spatial_db_data:
  asset_db_data:
  dpanel_data:
  n8n_data:

networks:
  geonexus-net:
    driver: bridge
