<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoNexus æ•°æ®ä¸­å° - CesiumJS ä¸‰ç»´æµ‹è¯•å®¢æˆ·ç«¯</title>
    <!-- å¼•å…¥ CesiumJS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }
        
        .control-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        .control-panel select, .control-panel button {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .control-panel button {
            background-color: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .control-panel button:hover {
            background-color: #1557b0;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            max-height: 80%;
            overflow-y: auto;
            display: none;
        }
        
        .info-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        .info-panel table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .info-panel th, .info-panel td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .info-panel th {
            font-weight: bold;
        }
        
        .media-container {
            margin-top: 10px;
        }
        
        .media-container img {
            max-width: 100%;
            margin-bottom: 10px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 18px;
            z-index: 2;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Cesium å®¹å™¨ -->
    <div id="cesiumContainer"></div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <h3>GeoNexus æ•°æ®ä¸­å°</h3>
        <select id="dataSourceSelect">
            <option value="">-- é€‰æ‹©æ•°æ®æº --</option>
            <optgroup label="PostGIS Enterprise Provider">
                <option value="/provider-postgis-enterprise/public.business_features">ä¸šåŠ¡è¦ç´ </option>
                <option value="/provider-postgis-enterprise/public.buildings">å»ºç­‘</option>
                <option value="/provider-postgis-enterprise/public.pois">å…´è¶£ç‚¹</option>
            </optgroup>
            <optgroup label="DTS Provider">
                <option value="/provider-dts/buildings">å»ºç­‘</option>
                <option value="/provider-dts/pois">å…´è¶£ç‚¹</option>
                <option value="/provider-dts/default">é»˜è®¤åœºæ™¯</option>
            </optgroup>
        </select>
        <button id="loadDataBtn">åŠ è½½æ•°æ®</button>
        <button id="clearDataBtn">æ¸…é™¤æ•°æ®</button>
    </div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel" id="infoPanel">
        <h3>è¦ç´ ä¿¡æ¯</h3>
        <div id="featureInfo"></div>
        <div id="mediaContainer" class="media-container"></div>
    </div>
    
    <!-- åŠ è½½æç¤º -->
    <div class="loading" id="loadingIndicator">æ•°æ®åŠ è½½ä¸­...</div>
    
    <!-- è„šæœ¬ -->
    <script>
        // ä½¿ç”¨å…¬å…±ä»¤ç‰Œ - ä»…ç”¨äºå¼€å‘æµ‹è¯•
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5N2UyMjcwOS00MDY1LTQxYjEtYjZjMy00YTU0ZTg5MmViYWQiLCJpZCI6ODAzMDYsImlhdCI6MTY0Mjc0ODI2MX0.dkwAL1CcljUV7NA7fDbhXXnmyZQU_c-G5zRx8PtEcxE';
        
        // åˆ›å»º Cesium Viewerï¼Œä½¿ç”¨ OpenStreetMap ä½œä¸ºåº•å›¾
        const viewer = new Cesium.Viewer('cesiumContainer', {
            baseLayerPicker: false, // ç¦ç”¨åº•å›¾é€‰æ‹©å™¨
            geocoder: false, // ç¦ç”¨åœ°ç†ç¼–ç å™¨
            homeButton: false, // ç¦ç”¨ä¸»é¡µæŒ‰é’®
            sceneModePicker: false, // ç¦ç”¨åœºæ™¯æ¨¡å¼é€‰æ‹©å™¨
            navigationHelpButton: false, // ç¦ç”¨å¯¼èˆªå¸®åŠ©æŒ‰é’®
            animation: false, // ç¦ç”¨åŠ¨ç”»æ§ä»¶
            timeline: false, // ç¦ç”¨æ—¶é—´çº¿æ§ä»¶
            fullscreenButton: false, // ç¦ç”¨å…¨å±æŒ‰é’®
            infoBox: false, // ç¦ç”¨ä¿¡æ¯æ¡†
            imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                url: 'https://a.tile.openstreetmap.org/'
            })
        });
        
        // ç§»é™¤ç‰ˆæƒä¿¡æ¯
        viewer.cesiumWidget.creditContainer.style.display = 'none';
        
        // è®¾ç½®åˆå§‹è§†å›¾ - ä¸­å›½ä¸­éƒ¨
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(116.4, 39.9, 1000000),
            orientation: {
                heading: 0.0,
                pitch: -Cesium.Math.PI_OVER_TWO,
                roll: 0.0
            }
        });
        
        // è·å–DOMå…ƒç´ 
        const dataSourceSelect = document.getElementById('dataSourceSelect');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const infoPanel = document.getElementById('infoPanel');
        const featureInfo = document.getElementById('featureInfo');
        const mediaContainer = document.getElementById('mediaContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // å½“å‰åŠ è½½çš„æ•°æ®æº
        let currentDataSource = null;
        
        // åŠ è½½æ•°æ®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        loadDataBtn.addEventListener('click', async () => {
            const serviceUrl = dataSourceSelect.value;
            
            if (!serviceUrl) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ•°æ®æº');
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„æ•°æ®
            clearData();
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            loadingIndicator.style.display = 'block';
            
            try {
                await loadDataFromKoop(serviceUrl);
            } finally {
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                loadingIndicator.style.display = 'none';
            }
        });
        
        // æ¸…é™¤æ•°æ®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        clearDataBtn.addEventListener('click', () => {
            clearData();
        });
        
        // ä»KoopåŠ è½½æ•°æ®
        async function loadDataFromKoop(serviceUrl) {
            try {
                // æ„å»ºæŸ¥è¯¢URLï¼Œè¯·æ±‚GeoJSONæ ¼å¼
                const queryUrl = `${serviceUrl}/FeatureServer/0/query?f=geojson&where=1=1&outFields=*`;
                
                console.log('æ­£åœ¨è¯·æ±‚æ•°æ®:', queryUrl);
                
                const response = await fetch(queryUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ ${response.status}: ${await response.text()}`);
                }
                
                const geojsonData = await response.json();
                
                console.log('æ•°æ®åŠ è½½æˆåŠŸ:', geojsonData);
                
                if (!geojsonData.features || geojsonData.features.length === 0) {
                    alert('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¦ç´ ');
                    return;
                }
                
                // ä½¿ç”¨Cesiumçš„GeoJsonDataSourceåŠ è½½æ•°æ®
                const dataSource = await Cesium.GeoJsonDataSource.load(geojsonData, {
                    stroke: Cesium.Color.HOTPINK,
                    fill: Cesium.Color.PINK.withAlpha(0.5),
                    strokeWidth: 3,
                    markerSymbol: 'ğŸ“'
                });
                
                // å°†æ•°æ®æºæ·»åŠ åˆ°viewerä¸­
                viewer.dataSources.add(dataSource);
                currentDataSource = dataSource;
                
                // è‡ªåŠ¨ç¼©æ”¾åˆ°æ•°æ®æ˜¾ç¤ºèŒƒå›´
                viewer.flyTo(dataSource);
                
                // ä¸ºæ¯ä¸ªå®ä½“æ·»åŠ ç‚¹å‡»äº‹ä»¶
                setupEntityClickHandlers(dataSource);
                
                console.log('æ•°æ®æ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('ä»KoopåŠ è½½æ•°æ®å¤±è´¥:', error);
                alert(`åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ¸…é™¤æ•°æ®
        function clearData() {
            if (currentDataSource) {
                viewer.dataSources.remove(currentDataSource);
                currentDataSource = null;
            }
            
            // éšè—ä¿¡æ¯é¢æ¿
            infoPanel.style.display = 'none';
        }
        
        // è®¾ç½®å®ä½“ç‚¹å‡»äº‹ä»¶å¤„ç†
        function setupEntityClickHandlers(dataSource) {
            // ç›‘å¬é€‰ä¸­å®ä½“å˜åŒ–äº‹ä»¶
            viewer.selectedEntityChanged.addEventListener(async (selectedEntity) => {
                if (selectedEntity) {
                    displayEntityInfo(selectedEntity);
                } else {
                    // éšè—ä¿¡æ¯é¢æ¿
                    infoPanel.style.display = 'none';
                }
            });
        }
        
        // æ˜¾ç¤ºå®ä½“ä¿¡æ¯
        function displayEntityInfo(entity) {
            if (!entity || !entity.properties) {
                return;
            }
            
            // æ˜¾ç¤ºä¿¡æ¯é¢æ¿
            infoPanel.style.display = 'block';
            
            // è·å–å®ä½“å±æ€§
            const properties = entity.properties;
            
            // æ„å»ºHTMLè¡¨æ ¼æ˜¾ç¤ºå±æ€§
            let tableHtml = '<table>';
            
            // éå†æ‰€æœ‰å±æ€§
            for (const key in properties) {
                if (properties.hasOwnProperty(key) && key !== 'asset_ids') {
                    const value = properties[key]._value || properties[key];
                    tableHtml += `<tr><th>${key}</th><td>${value}</td></tr>`;
                }
            }
            
            tableHtml += '</table>';
            featureInfo.innerHTML = tableHtml;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„èµ„äº§ID
            if (properties.asset_ids && properties.asset_ids._value) {
                loadAssetMedia(properties.asset_ids._value);
            } else {
                mediaContainer.innerHTML = '<p>æ²¡æœ‰å…³è”åª’ä½“èµ„äº§</p>';
            }
        }
        
        // åŠ è½½èµ„äº§åª’ä½“
        async function loadAssetMedia(assetIds) {
            try {
                mediaContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½åª’ä½“èµ„äº§...</p>';
                
                // å¦‚æœassetIdsæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸ºæ•°ç»„
                if (typeof assetIds === 'string') {
                    try {
                        assetIds = JSON.parse(assetIds);
                    } catch (e) {
                        assetIds = [assetIds];
                    }
                }
                
                if (!Array.isArray(assetIds)) {
                    assetIds = [assetIds];
                }
                
                // è¿™é‡Œåº”è¯¥è°ƒç”¨DAMæœåŠ¡APIè·å–èµ„äº§ä¿¡æ¯
                // ç”±äºæˆ‘ä»¬æ²¡æœ‰å®é™…çš„DAMæœåŠ¡ï¼Œè¿™é‡Œæ¨¡æ‹Ÿä¸€äº›ç¤ºä¾‹åª’ä½“
                const mediaHtml = assetIds.map(id => {
                    // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„åª’ä½“
                    if (id.includes('asset1')) {
                        return `<img src="https://via.placeholder.com/300x200?text=èµ„äº§ID:${id}" alt="èµ„äº§ ${id}">`;
                    } else if (id.includes('asset2')) {
                        return `<video width="100%" controls><source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾</video>`;
                    } else {
                        return `<div style="padding: 10px; background-color: #f0f0f0; margin-bottom: 10px;">èµ„äº§ ${id} (æ–‡æ¡£)</div>`;
                    }
                }).join('');
                
                mediaContainer.innerHTML = mediaHtml || '<p>æ²¡æœ‰å¯æ˜¾ç¤ºçš„åª’ä½“</p>';
            } catch (error) {
                console.error('åŠ è½½åª’ä½“èµ„äº§å¤±è´¥:', error);
                mediaContainer.innerHTML = `<p>åŠ è½½åª’ä½“èµ„äº§å¤±è´¥: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>